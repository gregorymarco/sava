<!-- Chat Component for Lobby -->

<!-- Chat toggle button -->
<button class="chat-toggle" id="chat-toggle" onclick="toggleChat()">
    <div class="chat-icon">ðŸ’¬</div>
</button>

<!-- Chat Window -->
<div class="chat-window" id="chat-window">
    <div class="chat-header">
        <div class="chat-title">ðŸ’¬ Chat</div>
        <button class="close-chat-btn" onclick="closeChat()">Ã—</button>
    </div>
    
    <div class="chat-messages" id="chat-messages">
        <div class="chat-welcome">Welcome to the lobby! Start chatting with other players.</div>
    </div>
    
    <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type a message..." maxlength="500" onkeypress="handleChatKeyPress(event)">
        <button class="send-btn" onclick="sendChatMessage()">Send</button>
    </div>
</div>

<script>
// Chat functionality
function toggleChat() {
    const chatWindow = document.getElementById('chat-window');
    const chatToggle = document.getElementById('chat-toggle');
    
    if (chatWindow.classList.contains('open')) {
        closeChat();
    } else {
        openChat();
    }
}

function openChat() {
    const chatWindow = document.getElementById('chat-window');
    const chatToggle = document.getElementById('chat-toggle');
    
    chatWindow.classList.add('open');
    chatToggle.classList.add('active');
    
    // Focus on chat input
    setTimeout(() => {
        document.getElementById('chat-input').focus();
    }, 100);
}

function closeChat() {
    const chatWindow = document.getElementById('chat-window');
    const chatToggle = document.getElementById('chat-toggle');
    
    chatWindow.classList.remove('open');
    chatToggle.classList.remove('active');
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

async function sendChatMessage() {
    const chatInput = document.getElementById('chat-input');
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    // Check message length (also enforced on server)
    if (message.length > 500) {
        alert('Message too long. Maximum 500 characters.');
        return;
    }
    
    try {
        // Send via WebSocket for real-time delivery
        const lobbyId = document.getElementById('lobby-id').textContent;
        
        // Send chat message via WebSocket
        socket.emit('send_chat_message', {
            lobby_id: lobbyId,
            message: message,
            player_id: playerId
        });
        
        // Clear input
        chatInput.value = '';
        
    } catch (error) {
        console.error('Failed to send chat message:', error);
        // You could show an error message to the user here
    }
}

function loadChatMessages() {
    if (!lobbyState || !lobbyState.game_state || !lobbyState.game_state.chat_messages) {
        return;
    }
    
    const chatMessages = document.getElementById('chat-messages');
    
    // Remove welcome message if it exists
    const welcomeMessage = chatMessages.querySelector('.chat-welcome');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
    
    // Add all existing messages
    lobbyState.game_state.chat_messages.forEach(message => {
        addChatMessage(message, false); // false = don't animate
    });
}

function addChatMessage(messageData, animate = true) {
    const chatMessages = document.getElementById('chat-messages');
    
    // Remove welcome message if it still exists
    const welcomeMessage = chatMessages.querySelector('.chat-welcome');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
    
    // Create message element
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message';
    
    // Determine message type (own, other, spectator)
    const isOwnMessage = messageData.player_id === playerId;
    const isSpectator = messageData.is_spectator;
    
    if (isOwnMessage) {
        messageElement.classList.add('own');
    } else if (isSpectator) {
        messageElement.classList.add('spectator');
    } else {
        messageElement.classList.add('other');
    }
    
    if (animate) {
        messageElement.classList.add('new');
    }
    
    // Format timestamp
    const timestamp = new Date(messageData.timestamp).toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    // Determine player color class
    let playerColorClass = '';
    if (!isSpectator) {
        playerColorClass = messageData.player_color;
    } else {
        playerColorClass = 'spectator';
    }
    
    // Create message HTML
    messageElement.innerHTML = `
        <div class="message-header">
            <span class="player-name ${playerColorClass}">${messageData.player_name}</span>
            <span class="message-timestamp">${timestamp}</span>
        </div>
        <div class="message-content">${messageData.message}</div>
    `;
    
    // Add to chat
    chatMessages.appendChild(messageElement);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>